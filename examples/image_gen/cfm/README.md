Adapted from https://github.com/atong01/conditional-flow-matching