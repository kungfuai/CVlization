Adapted from https://github.com/tqch/ddpm-torch/blob/master/train.py